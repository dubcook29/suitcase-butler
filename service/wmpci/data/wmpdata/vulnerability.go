package wmpdata

import (
	"encoding/json"
	"time"

	"github.com/google/uuid"
	"github.com/suitcase/butler/wmpci/data/model"
)

type Vulnerability struct {
	model.WMPDataModelBasicStructure `json:"wmpdatamodelbasicstructure" bson:"wmpdatamodelbasicstructure"`
	PortServiceId                    string `json:"port_service_id,omitempty" bson:"port_service_id"`

	Affects     []string `json:"affects,omitempty" bson:"affects"`
	Targets     string   `json:"targets,omitempty" bson:"targets"`
	CVSSDetail  string   `json:"cvss_detail,omitempty" bson:"cvss_detail"`
	CVSSScore   float64  `json:"cvss_score,omitempty" bson:"cvss_score"`
	Description string   `json:"description,omitempty" bson:"description"`
	Details     string   `json:"details,omitempty" bson:"details"`
	Criticality float64  `json:"criticality,omitempty" bson:"criticality"`
}

func (v Vulnerability) Key() string {
	return "vulnerability"
}

func (v Vulnerability) Exchange(data map[string][]interface{}) map[string][]interface{} {
	if val, ok := data[v.Key()]; ok {
		data[v.Key()] = append(val, v)
	} else {
		data[v.Key()] = []interface{}{v}
	}
	return data
}

func (v Vulnerability) DataModel() model.WMPDataModelBasicStructure {
	return v.WMPDataModelBasicStructure
}

func (v Vulnerability) JSON() (json.RawMessage, error) {
	return json.Marshal(&v)
}

func (v Vulnerability) New(assetId string) Vulnerability {
	v.WMPDataModelBasicStructure.CreatedAt = time.Now()
	v.WMPDataModelBasicStructure.UpdatedAt = time.Now()
	v.WMPDataModelBasicStructure.AssetId = assetId
	v.WMPDataModelBasicStructure.Identifier = uuid.NewString()
	v.WMPDataModelBasicStructure.DataModelKey = v.Key()
	return v
}
